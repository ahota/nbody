<html>
	<head>
		<title>3D NBody simulation</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
			#map
			{
				position: absolute;
				width: 100%;
				height: 100%;
			}
		</style>
		<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r69/three.js"></script>
		<script src="./lib/OrbitControls.js"></script>
		<script src="./lib/papaparse.min.js"></script>
        <script src='./lib/tween.min.js'></script>
        <script id="vertexShader" type="x-shader/x-vertex">
            uniform vec3 viewVector;
            uniform float c;
            uniform float p;
            varying float intensity;
            void main() 
            {
                vec3 vNormal = normalize( normalMatrix * normal );
                vec3 vNormel = normalize( normalMatrix * viewVector );
                intensity = pow( c - dot(vNormal, vNormel), p );
                
                gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
            }
        </script>

        <!-- fragment shader a.k.a. pixel shader -->
        <script id="fragmentShader" type="x-shader/x-vertex"> 
            uniform vec3 glowColor;
            varying float intensity;
            void main() 
            {
                vec3 glow = glowColor * intensity;
                gl_FragColor = vec4( glow, 0.5 );
            }
        </script>
		<script>
            var data;
            var timestep = 0;
            var objects = [];
            var glows = [];
            var pause = false;

            configs = {};
            configs.filename = "/data/simulation.csv";
            configs.n_bodies = 1024;
            configs.n_timesteps = 2500;
            configs.radius = 3.5;
            configs.speed = 25;
            configs.color = 0x00ff00;

            $(document).ready(function(){
				var controls;
				var camera;
				var scene;
				var renderer;

                Papa.parse(configs.filename, {
                    download: true,
                    dynamicTyping: true,
                    delimiter: ",",
                    complete: function(results)
                    {
                        data = results.data;
                        init();
                    }
                });

				function init()
				{
					renderer = new THREE.WebGLRenderer();
				    renderer.setSize(window.innerWidth, window.innerHeight);
					renderer.setClearColor( 0x000000, 1);
				    document.body.appendChild(renderer.domElement);
				    camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 1000);
				    camera.position.set(0, 0, 200);
				    camera.lookAt(new THREE.Vector3(0, 0, 0));
				    scene = new THREE.Scene();

					controls = new THREE.OrbitControls(camera);
					controls.addEventListener('change', render);

                    var texture = new THREE.ImageUtils.loadTexture( '/images/glow.png' );
                    var geometry = new THREE.SphereGeometry(configs.radius, 32, 32);
                    var material = new THREE.MeshBasicMaterial({color: 0x00ff00});

                    var customMaterial = new THREE.ShaderMaterial( 
                    {
                        uniforms: 
                        { 
                            "c":   { type: "f", value: 0.0 },
                            "p":   { type: "f", value: 60.0 },
                            glowColor: { type: "c", value: new THREE.Color(configs.color) },
                            viewVector: { type: "v3", value: camera.position }
                        },
                        vertexShader:   document.getElementById( 'vertexShader'   ).textContent,
                        fragmentShader: document.getElementById( 'fragmentShader' ).textContent,
                        side: THREE.BackSide,
                        blending: THREE.AdditiveBlending,
                        transparent: true
                    });

                    for (var i = 0; i < configs.n_bodies; i++)
                    {
                        var sphere = new THREE.Mesh(geometry, customMaterial);
                        sphere.position.x += data[i][0];
                        sphere.position.x += data[i][1];
                        sphere.position.x += data[i][2];

						/*var spriteMaterial = new THREE.SpriteMaterial(
						{
							map: texture,
							useScreenCoordinates: false,
							color: 0x00ff00, transparent: true, blending: THREE.AdditiveBlending
						});
						var sprite = new THREE.Sprite( spriteMaterial );
						sprite.scale.set(2, 2,  0.9);
						sphere.add(sprite);*/

                        //var glow = new THREE.Mesh(geometry, customMaterial);
                        //glow.position = sphere.position;
                        //glow.scale.multiplyScalar(5);
                        //scene.add(glow);
                        //glows.push(glow);

                        scene.add(sphere);
                        objects.push(sphere);
                    }

					var size = 100;
					var step = 2;

					var gridHelper = new THREE.GridHelper( size, step );
					gridHelper.setColors(new THREE.Color(0x333333), new THREE.Color(0x333333));
					scene.add( gridHelper );

    				renderer.render(scene, camera);

                    timestep = 0;
                    setInterval(function(){
                        if (!pause)
                        {
                            controls.update();
                            render(timestep++);
                        }
                    }, configs.speed);
				}

                function update_positions(timestep)
                {
                    if (timestep < configs.n_timesteps)
                    {
                        $("#info").text("t=" + timestep.toString());
                        for (var i = 0; i < configs.n_bodies; i++)
                        {
                            objects[i].position.x = data[configs.n_bodies * timestep + i][0];
                            objects[i].position.y = data[configs.n_bodies * timestep + i][1];
                            objects[i].position.z = data[configs.n_bodies * timestep + i][2];
                            //glows[i].position.x = objects[i].position.x;
                            //glows[i].position.y = objects[i].position.y;
                            //glows[i].position.z = objects[i].position.z;
                        }
                    }
                }

				function render(timestep)
				{
                    update_positions(timestep);
					renderer.render(scene, camera);
				}

                $(window).keypress(function(e){
                    var key = e.which;
                    if (key == 112)
                    {
                        pause = !pause;                   
                    }                   
                });
			});
		</script>
	</head>
	<body>
        <div id="info" style="color: white; position: absolute; top: 10px; left: 10px; z-index: 10000;"></div>
	</body>
</html>
